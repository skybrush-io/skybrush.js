# `@skybrush/mavlink`

This package contains MAVLink message implementations for various MAVLink
dialects.

The implementation is based on the MAVLink files generated by `mavgen.py` in
`pymavlink`. You can generate a copy of these files by checking out the
official `pymavlink` repo and then running:

```sh
cd generator
./gen_js.sh
```

The `gen_js.sh` script needs the official MAVLink message definitions to be
present in a folder named `message_definitions` on the same level as
`pymavlink` is. For me it was more convenient to do the following:

```sh
git clone https://github.com/mavlink/mavlink
git clone https://github.com/ArduPilot/pymavlink
cd pymavlink
./gen_js.sh
```

but this requires one to patch the `gen_js.sh` shell script to look for
`message_definitions` in the appropriate folder of the `mavlink` repo.

## Chnages made to the generated implementations

The generated implementations are not exactly modern idiomatic
JavaScript (to put it mildly), and they use a patched version of the
third-party `jspack` and `long` libraries. The patches to `long` are relatively
benign and they can easily be traced by diffing the source against the original
(version 4.0.0), but the `jspack` code was also reformatted, which makes it
extremely hard to figure out where the real changes are. Therefore, I have
simply vendored `long` and `jspack` in the source tree and modified the
generated JavaScript implementations of the MAVLink message processors to use
the vendored variants.

* The generated implementations also depend on `underscore`, which is
  unfortunate because `lodash` would be so much better, but alas.

* The generated implementations import the `util` module from Node.js, but the
  only function they use from it is `inherits`, which is provided by a separate
  package on NPM. To avoid having to shim the entire `util` module in browser
  environments, I have modified the generated implementation to depend on
  `inherits` only.

* The generated implementations assume that `Buffer` is in the global
  namespace, which is true for Node.js but not for browser environments.
  Therefore, we explicitly import `Buffer` from the `buffer` module to cater
  for both environments.

## Additional caveats

When using this module in a browser environment. `crypto` and `stream` have to
be polyfilled from `crypto-browserify` and `stream-browserify`.

